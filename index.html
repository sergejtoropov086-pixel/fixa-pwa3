<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa Pro ‚Äî –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</title>
  <meta name="description" content="–ü–æ–ª–Ω—ã–π offline-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–µ –∏ –∑–¥–æ—Ä–æ–≤—å—é. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –æ–±–ª–∞–∫–∞.">
  <style id="theme-styles">
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --btn-bg: #1d4ed8;
      --btn-hover: #1e40af;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --border: #e2e8f0;
    }
    .dark-mode {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 16px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin: 20px 0; position: relative; }
    h1 { font-size: 28px; color: var(--btn-bg); margin: 10px 0; }
    #status { font-size: 16px; color: var(--text-secondary); margin-top: 8px; }
    #search { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 10px; background: var(--card-bg); color: var(--text); }
    nav { display: grid; gap: 12px; margin: 20px 0; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: var(--btn-bg); color: white; cursor: pointer; transition: background 0.2s; }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #0da172; }
    button:hover { background: var(--btn-hover); }
    button:active { transform: scale(0.98); }
    #content { margin-top: 20px; }
    .card, .db-item { background: var(--card-bg); padding: 16px; border-radius: 14px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; }
    .hidden { display: none; }
    #form-container { margin-top: 20px; background: var(--card-bg); padding: 20px; border-radius: 14px; box-shadow: var(--shadow); }
    input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--card-bg); color: var(--text); }
    input:focus, textarea:focus, select:focus { outline: 2px solid var(--btn-bg); }
    img.preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .error { color: var(--danger); margin: 10px 0; padding: 10px; background: #fef2f2; border-radius: 8px; }
    .loader { display: none; text-align: center; margin: 10px 0; color: var(--btn-bg); }
    footer { text-align: center; margin-top: 30px; color: var(--text-secondary); font-size: 14px; }
    #charts { margin-top: 20px; }
    .chart-bar { height: 20px; background: var(--btn-bg); border-radius: 4px; margin-top: 5px; }
    #theme-toggle, #lang-toggle { position: absolute; top: 16px; right: 16px; background: var(--btn-bg); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; z-index: 10; }
    #lang-toggle { right: 60px; }
    .tab { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
    .tab-btn { flex: 1; min-width: 120px; padding: 10px; background: var(--border); color: var(--text); border: none; border-radius: 8px; }
    .tab-btn.active { background: var(--btn-bg); color: white; }
    .status-in_stock { color: var(--success); }
    .status-expected { color: #f59e0b; }
    .status-purchased { color: #6b7280; }
  </style>
</head>
<body>
  <button id="theme-toggle">üåô</button>
  <button id="lang-toggle">üá∑üá∫</button>

  <header>
    <h1>Fixa Pro</h1>
    <p id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
  </header>

  <div class="tab">
    <button class="tab-btn active" data-tab="main">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
    <button class="tab-btn" data-tab="spare-parts">üîß –ó–∞–ø—á–∞—Å—Ç–∏</button>
    <button class="tab-btn" data-tab="health-db">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    <button class="tab-btn" data-tab="services">üè• –°–µ—Ä–≤–∏—Å—ã</button>
  </div>

  <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª—è–º, –∞—Ä—Ç–∏–∫—É–ª–∞–º, –∑–∞–ø—á–∞—Å—Ç—è–º...">
  
  <!-- –û–°–ù–û–í–ù–ê–Ø –í–ö–õ–ê–î–ö–ê -->
  <div id="main-tab">
    <nav>
      <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
      <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
      <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
      <button id="import-json">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
      <button id="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
      <button id="backup" class="btn-success">üì¶ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</button>
    </nav>

    <div id="form-container" class="hidden"></div>
    <div id="charts"></div>

    <div id="content">
      <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
      <div id="list-appliances"></div>
      <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
      <div id="list-health"></div>
    </div>
  </div>

  <!-- –ó–ê–ü–ß–ê–°–¢–ò -->
  <div id="spare-parts-tab" class="hidden">
    <input type="text" id="spare-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π (–∞—Ä—Ç–∏–∫—É–ª, –º–æ–¥–µ–ª—å)">
    <div id="spare-list"></div>
  </div>

  <!-- –ó–î–û–†–û–í–¨–ï -->
  <div id="health-db-tab" class="hidden">
    <h3>–°–∏–º–ø—Ç–æ–º—ã</h3>
    <div id="symptom-list"></div>
    <h3>–ü—Ä–µ–ø–∞—Ä–∞—Ç—ã</h3>
    <div id="medicine-list"></div>
  </div>

  <!-- –°–ï–†–í–ò–°–´ -->
  <div id="services-tab" class="hidden">
    <h3>–°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã</h3>
    <div id="service-list"></div>
    <h3>–ê–ø—Ç–µ–∫–∏</h3>
    <div id="pharmacy-list"></div>
    <h3>–ú–∞–≥–∞–∑–∏–Ω—ã –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</h3>
    <div id="store-list"></div>
  </div>

  <footer>
    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Ä¢ –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Ä¢ –ë–µ–∑ –æ–±–ª–∞–∫–∞
  </footer>

  <!-- –í–°–¢–†–û–ï–ù–ù–´–ô jsPDF (–º–∏–Ω–∏-–≤–µ—Ä—Å–∏—è) -->
  <script>
    // –ú–∏–Ω–∏-–≤–µ—Ä—Å–∏—è jsPDF (—Ç–æ–ª—å–∫–æ —ç–∫—Å–ø–æ—Ä—Ç –≤ PDF —á–µ—Ä–µ–∑ print)
    window.jsPDF = {
      create() {
        return {
          save(name) {
            alert('PDF –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ü–µ—á–∞—Ç—å ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF¬ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
          }
        };
      }
    };
  </script>

  <script>
    // ======================
    // === –í–°–¢–†–û–ï–ù–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• (–±–µ–∑ fetch!) ===
    // ======================
    const FixaDB = {
      spareParts: [
        { brand: "Bosch", model: "WAT28400", name: "–†–µ–º–µ–Ω—å –ø—Ä–∏–≤–æ–¥–∞", partNumber: "12345678", status: "in_stock", price: 850 },
        { brand: "Indesit", model: "WIUN 81", name: "–©—ë—Ç–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è", partNumber: "98765432", status: "expected", price: 320 },
        { brand: "Atlant", model: "MXM-1704", name: "–¢–µ—Ä–º–æ—Å—Ç–∞—Ç", partNumber: "11223344", status: "purchased", price: 600 }
      ],
      symptoms: [
        { name: "–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å", possibleDiagnoses: ["–°—Ç—Ä–µ—Å—Å", "–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–ú–∏–≥—Ä–µ–Ω—å"] },
        { name: "–¢–æ—à–Ω–æ—Ç–∞", possibleDiagnoses: ["–ü–∏—â–µ–≤–æ–µ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ", "–í–∏—Ä—É—Å", "–ú–∏–≥—Ä–µ–Ω—å"] }
      ],
      medicines: [
        { name: "–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª", use: "–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ, –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ", contraindications: "–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å" },
        { name: "–°–º–µ–∫—Ç–∞", use: "–°–æ—Ä–±–µ–Ω—Ç –ø—Ä–∏ –¥–∏–∞—Ä–µ–µ", contraindications: "–ù–µ–ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –∫–∏—à–µ—á–Ω–∏–∫–∞" }
      ],
      serviceCenters: [
        { name: "–°–µ—Ä–≤–∏—Å Bosch", address: "—É–ª. –õ–µ–Ω–∏–Ω–∞, 10", phone: "+7 (343) 123-45-67" }
      ],
      pharmacies: [
        { name: "–ê–ø—Ç–µ–∫–∞ 36.6", address: "–ø—Ä. –ö–æ—Å–º–æ–Ω–∞–≤—Ç–æ–≤, 25", phone: "+7 (343) 987-65-43" }
      ],
      stores: [
        { name: "–ú.–í–∏–¥–µ–æ", address: "—É–ª. –ú–∞–ª—ã—à–µ–≤–∞, 50", phone: "+7 (343) 555-55-55" }
      ]
    };

    // ======================
    // === –•–†–ê–ù–ï–ù–ò–ï ===
    // ======================
    const Storage = {
      save(type, item) {
        const items = this.load(type);
        item.id = Date.now();
        item.date = new Date().toISOString();
        items.push(item);
        try {
          localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        } catch (e) {
          alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ.');
        }
        return item;
      },
      load(type) {
        try {
          const data = localStorage.getItem(`fixa_${type}`);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      },
      remove(type, id) {
        const items = this.load(type).filter(i => i.id !== id);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
      },
      getAll() {
        return {
          appliances: this.load('appliances'),
          health: this.load('health')
        };
      },
      backup() {
        const data = this.getAll();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fixa_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        localStorage.setItem('fixa_next_backup', (Date.now() + 7 * 24 * 60 * 60 * 1000).toString());
        alert('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
      }
    };

    // ======================
    // === UI ===
    // ======================
    const UI = {
      formatDate(iso) {
        if (!iso) return '‚Äî';
        try {
          const date = new Date(iso);
          if (isNaN(date.getTime())) return '‚Äî';
          return date.toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          });
        } catch {
          return '‚Äî';
        }
      },

      escape(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '<', '>': '>', '"': '&quot;', "'": '&#039;' }[m]));
      },

      renderCount() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');
        document.getElementById('status').innerText = `‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ—Ö–Ω–∏–∫–∞: ${appliances.length} | –ó–¥–æ—Ä–æ–≤—å–µ: ${health.length}`;
        this.renderCharts();
      },

      renderCharts() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');
        
        const monthsAppl = this.getMonthsData(appliances);
        const maxAppl = Math.max(...Object.values(monthsAppl));
        let html = '<h3>–¢–µ—Ö–Ω–∏–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>';
        html += this.renderChart(monthsAppl, maxAppl);

        const monthsHealth = this.getMonthsData(health);
        const maxHealth = Math.max(...Object.values(monthsHealth));
        html += '<h3>–ó–¥–æ—Ä–æ–≤—å–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>';
        html += this.renderChart(monthsHealth, maxHealth);

        document.getElementById('charts').innerHTML = html;
      },

      getMonthsData(items) {
        const months = {};
        const now = new Date();
        for (let i = 11; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          months[key] = 0;
        }
        items.forEach(a => {
          try {
            const d = new Date(a.date);
            const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            if (months[key] !== undefined) months[key]++;
          } catch {}
        });
        return months;
      },

      renderChart(months, max) {
        let html = '<div style="display:flex;align-items:end;height:100px;gap:4px;">';
        Object.entries(months).forEach(([key, count]) => {
          const height = max > 0 ? (count / max) * 80 : 0;
          const label = key.split('-')[1];
          html += `<div style="flex:1;text-align:center;">
            <div class="chart-bar" style="height:${height}px;"></div>
            <small>${label}</small>
          </div>`;
        });
        html += '</div>';
        return html;
      },

      renderList(filter = '') {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');

        const filteredAppl = filter ? appliances.filter(a => 
          a.model.toLowerCase().includes(filter.toLowerCase()) ||
          a.problem?.toLowerCase().includes(filter.toLowerCase())
        ) : appliances;

        const filteredHealth = filter ? health.filter(h => 
          h.symptom.toLowerCase().includes(filter.toLowerCase()) ||
          h.notes?.toLowerCase().includes(filter.toLowerCase())
        ) : health;

        document.getElementById('list-appliances').innerHTML = filteredAppl.map(a =>
          `<div class="card">
            <button class="delete-btn" data-type="appliances" data-id="${a.id}">√ó</button>
            <strong>${this.escape(a.model)}</strong> (${this.escape(a.category)})<br>
            ${a.problem ? '<br><em>–ü—Ä–æ–±–ª–µ–º–∞:</em> ' + this.escape(a.problem) : ''}
            ${a.photo ? `<br><img src="${a.photo}" class="preview">` : ''}
            <br><small>${this.formatDate(a.date)}</small>
          </div>`
        ).join('');

        document.getElementById('list-health').innerHTML = filteredHealth.map(h =>
          `<div class="card">
            <button class="delete-btn" data-type="health" data-id="${h.id}">√ó</button>
            <strong>${this.escape(h.symptom)}</strong><br>
            ${h.notes ? '<br>' + this.escape(h.notes) : ''}
            <br><small>${this.formatDate(h.date)}</small>
          </div>`
        ).join('');

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = e.target.dataset.type;
            const id = Number(e.target.dataset.id);
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
              Storage.remove(type, id);
              this.renderList(filter);
              this.renderCount();
            }
          });
        });
      },

      renderSpareParts(filter = '') {
        const list = document.getElementById('spare-list');
        const items = filter ? FixaDB.spareParts.filter(p => 
          p.name.toLowerCase().includes(filter.toLowerCase()) ||
          p.partNumber.toLowerCase().includes(filter.toLowerCase()) ||
          p.model.toLowerCase().includes(filter.toLowerCase())
        ) : FixaDB.spareParts;
        
        list.innerHTML = items.slice(0, 200).map(p => `
          <div class="db-item">
            <strong>${p.name}</strong><br>
            –ê—Ä—Ç–∏–∫—É–ª: ${p.partNumber} | –ú–æ–¥–µ–ª—å: ${p.model}<br>
            –ë—Ä–µ–Ω–¥: ${p.brand}<br>
            <span class="status-${p.status}">
              ${p.status === 'in_stock' ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : p.status === 'expected' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è' : 'üõí –ö—É–ø–ª–µ–Ω–æ'}
            </span>
            ${p.price ? `<br>–¶–µ–Ω–∞: ${p.price} ‚ÇΩ` : ''}
          </div>
        `).join('');
      },

      renderHealthDB() {
        document.getElementById('symptom-list').innerHTML = FixaDB.symptoms.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã: ${s.possibleDiagnoses.join(', ')}
          </div>
        `).join('');
        
        document.getElementById('medicine-list').innerHTML = FixaDB.medicines.map(m => `
          <div class="db-item">
            <strong>${m.name}</strong><br>
            –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: ${m.use}<br>
            –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è: ${m.contraindications}
          </div>
        `).join('');
      },

      renderServices() {
        document.getElementById('service-list').innerHTML = FixaDB.serviceCenters.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${s.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${s.phone}
          </div>
        `).join('');
        
        document.getElementById('pharmacy-list').innerHTML = FixaDB.pharmacies.map(p => `
          <div class="db-item">
            <strong>${p.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${p.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${p.phone}
          </div>
        `).join('');
        
        document.getElementById('store-list').innerHTML = FixaDB.stores.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${s.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${s.phone}
          </div>
        `).join('');
      },

      showForm(type) {
        const container = document.getElementById('form-container');
        if (type === 'appliance') {
          container.innerHTML = `
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
            <select id="category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
              <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
              <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
              <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
              <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
              <option value="–¢–µ–ª–µ–≤–∏–∑–æ—Ä">–¢–µ–ª–µ–≤–∏–∑–æ—Ä</option>
              <option value="–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞">–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
            </select>
            <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"></textarea>
            <input type="file" id="photo" accept="image/*" capture="environment">
            <img id="photo-preview" class="preview hidden">
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          this.initPhotoPreview();
          document.getElementById('save-appliance').onclick = () => this.saveAppliance();
        } else {
          container.innerHTML = `
            <h3>–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</h3>
            <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
            <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ –∏ —Ç.–¥."></textarea>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          document.getElementById('save-health').onclick = () => this.saveHealth();
        }
        container.classList.remove('hidden');
        document.getElementById('cancel').onclick = () => container.classList.add('hidden');
      },

      initPhotoPreview() {
        const input = document.getElementById('photo');
        const preview = document.getElementById('photo-preview');
        input.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              preview.src = event.target.result;
              preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        });
      },

      saveAppliance() {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        if (!model || !category) {
          alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
          return;
        }
        let photo = '';
        const preview = document.getElementById('photo-preview');
        if (!preview.classList.contains('hidden')) {
          photo = preview.src;
        }
        Storage.save('appliances', { model, category, problem: document.getElementById('problem').value, photo });
        this.renderList(document.getElementById('search').value);
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      saveHealth() {
        const symptom = document.getElementById('symptom').value.trim();
        if (!symptom) {
          alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º');
          return;
        }
        Storage.save('health', { symptom, notes: document.getElementById('notes').value });
        this.renderList(document.getElementById('search').value);
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      exportJSON() {
        try {
          const data = Storage.getAll();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ JSON');
        }
      },

      importJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              if (data.appliances) localStorage.setItem('fixa_appliances', JSON.stringify(data.appliances));
              if (data.health) localStorage.setItem('fixa_health', JSON.stringify(data.health));
              this.renderList(document.getElementById('search').value);
              this.renderCount();
              alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } catch (err) {
              alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ JSON');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      },

      print() {
        const w = window.open('', '_blank');
        w.document.write(`
          <html><head><title>Fixa ‚Äî print</title>
          <style>
            body { font-family: sans-serif; padding: 20px; color: black; }
            .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
          </style>
          </head><body>
          <h2>–¢–µ—Ö–Ω–∏–∫–∞</h2>${document.getElementById('list-appliances').innerHTML}
          <h2>–ó–¥–æ—Ä–æ–≤—å–µ</h2>${document.getElementById('list-health').innerHTML}
          </body></html>
        `);
        w.document.close();
        w.focus();
        w.print();
        w.close();
      }
    };

    // ======================
    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      // –¢–µ–º–∞
      const savedDark = localStorage.getItem('fixa_dark_mode');
      if (savedDark === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
      }

      UI.renderCount();
      UI.renderList();

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã
      document.getElementById('theme-toggle').onclick = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('fixa_dark_mode', isDark.toString());
        document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      };

      // –ü–æ–∏—Å–∫
      document.getElementById('search').addEventListener('input', (e) => {
        UI.renderList(e.target.value);
      });
      document.getElementById('spare-search').addEventListener('input', (e) => {
        UI.renderSpareParts(e.target.value);
      });

      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#main-tab, #spare-parts-tab, #health-db-tab, #services-tab').forEach(div => div.classList.add('hidden'));
          const tab = btn.dataset.tab;
          document.getElementById(`${tab}-tab`).classList.remove('hidden');
          if (tab === 'spare-parts') UI.renderSpareParts();
          if (tab === 'health-db') UI.renderHealthDB();
          if (tab === 'services') UI.renderServices();
        });
      });

      // –ö–Ω–æ–ø–∫–∏
      document.getElementById('add-appliance').onclick = () => UI.showForm('appliance');
      document.getElementById('add-health').onclick = () => UI.showForm('health');
      document.getElementById('export-json').onclick = () => UI.exportJSON();
      document.getElementById('import-json').onclick = () => UI.importJSON();
      document.getElementById('print').onclick = () => UI.print();
      document.getElementById('backup').onclick = () => Storage.backup();

      // –ê–≤—Ç–æ–±—ç–∫–∞–ø
      const nextBackup = localStorage.getItem('fixa_next_backup');
      if (nextBackup && Date.now() > Number(nextBackup)) {
        Storage.backup();
      }
    });
  </script>
</body>
</html>

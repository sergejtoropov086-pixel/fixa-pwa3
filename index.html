<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa ‚Äî –†–µ–º–æ–Ω—Ç –∏ –ó–¥–æ—Ä–æ–≤—å–µ</title>
  <meta name="description" content="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ–º—å–∏. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ.">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png" />
  <meta name="theme-color" content="#1a73e8" />

  <!-- Service Worker –¥–ª—è offline -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ SW:', err));
      });
    }
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: #f8fafc; color: #1e293b; padding: 16px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin: 20px 0; }
    h1 { font-size: 28px; color: #1d4ed8; margin: 10px 0; }
    #count { font-size: 16px; color: #64748b; margin-top: 8px; }
    nav { display: grid; gap: 12px; margin: 20px 0; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: #1d4ed8; color: white; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #1e40af; }
    button:active { transform: scale(0.98); }
    #content { margin-top: 20px; }
    .card { background: white; padding: 16px; border-radius: 14px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; }
    .hidden { display: none; }
    #form-container { margin-top: 20px; background: white; padding: 20px; border-radius: 14px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; }
    input:focus, textarea:focus, select:focus { outline: 2px solid #3b82f6; }
    img.preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .error { color: #ef4444; margin: 10px 0; padding: 10px; background: #fef2f2; border-radius: 8px; }
    footer { text-align: center; margin-top: 30px; color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>Fixa</h1>
    <p id="count">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </header>

  <nav>
    <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
    <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
    <button id="export-pdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
    <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <button id="import-json">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
    <button id="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
    <button id="scan-qr">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
    <button id="dictate">üé§ –î–∏–∫—Ç–æ–≤–∫–∞</button>
  </nav>

  <div id="form-container" class="hidden"></div>

  <div id="content">
    <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
    <div id="list-appliances"></div>
    <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="list-health"></div>
  </div>

  <footer>
    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Ä¢ –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Ä¢ –ë–µ–∑ –æ–±–ª–∞–∫–∞
  </footer>

  <!-- –í–°–¢–†–û–ï–ù–ù–´–ô jsPDF v2.5.1 (offline) -->
  <script>
    /*! jspdf 2.5.1 (https://github.com/parallax/jsPDF) */
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).jsPDF=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(){function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(){function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}return function(e,n,r){for(var o=0;o<n.length;o++)t(e,n[o],r[n[o]]);return e}}(),r=function(){return(r=Object.assign||function(t){for(var e,n=1;n<arguments.length;n++)for(var r in e=arguments[n],e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(r):void 0},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==("undefined"==typeof e?t:"undefined"==typeof e?"undefined":t(e))&&"function"!=typeof e?t:e},u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},l=function(){function t(e){o(this,t),this.callbacks=[],this.options=e||{},this.options.autoOpen=!1!==this.options.autoOpen,this.options.onClose=this.options.onClose||function(){},this.element=null,this.shown=!1,this.pdf=null,this.url=null}return i(t,[{key:"open",value:function(t,e){var n=this;this.pdf=t,this.url=URL.createObjectURL(new Blob([t.output("arraybuffer")],{type:"application/pdf"})),this.element||(this.element=document.createElement("iframe"),this.element.style.position="absolute",this.element.style.top="0",this.element.style.left="0",this.element.style.width="100%",this.element.style.height="100%",this.element.style.border="none",this.element.onload=function(){n.shown||(n.shown=!0,n.options.onClose(function(){n.close()}))}),this.element.src=this.url,document.body.appendChild(this.element),this.shown=!1,this.element.focus()}},{key:"close",value:function(){this.element&&(document.body.removeChild(this.element),this.element=null),this.url&&(URL.revokeObjectURL(this.url),this.url=null),this.shown=!1,this.callbacks.forEach(function(t){t()})}},{key:"onClose",value:function(t){this.callbacks.push(t)}}]),t}(),c=function(){function t(){o(this,t),this.internal={events:{}}}}return i(t,[{key:"on",value:function(t,e){return this.internal.events[t]||(this.internal.events[t]=[]),this.internal.events[t].push(e),this}},{key:"off",value:function(t,e){if(this.internal.events[t])if(e){var n=this.internal.events[t].indexOf(e);-1!==n&&this.internal.events[t].splice(n,1)}else this.internal.events[t]=[];return this}},{key:"emit",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return this.internal.events[t]&&this.internal.events[t].forEach(function(t){t.apply(void 0,n)}),this}}]),t}(),h=function(t){function e(){return o(this,e),s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return u(e,t),i(e,[{key:"output",value:function(t,e){var n,r;return"function"==typeof t?(r=t,t="save"):"string"==typeof t?(r=e):"object"===(void 0===t?"undefined":t(t))&&(n=t,t=n.type||"save",r=n.callback),t||(t="save"),"save"===t?this.save(e):"arraybuffer"===t?this.getArrayBuffer():"blob"===t?this.getBlob():"bloburi"===t||"bloburl"===t?this.getBlobURL():"datauristring"===t||"dataurlstring"===t?this.getDataURL("application/pdf"):"datauri"===t||"dataurl"===t?(r||console.log(this.getDataURL("application/pdf")),""):void 0}},{key:"save",value:function(t){t||(t="generated.pdf"),this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.pdfOpen&&this.pdfOpen.close();var e=this.output("blob");if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{var n=document.createElement("a");document.body.appendChild(n),n.style="display: none",n.href=window.URL.createObjectURL(e),n.download=t,n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}return this}},{key:"getArrayBuffer",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.internal.getArrayBuffer()}},{key:"getBlob",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),new Blob([this.output("arraybuffer")],{type:"application/pdf"})}},{key:"getBlobURL",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),window.URL.createObjectURL(this.getBlob())}},{key:"getDataURL",value:function(t){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),"data:"+t+";base64,"+btoa(this.getBinaryString())}},{key:"getBinaryString",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.internal.getBinaryString()}}]),e}(c),f=function(){function t(){o(this,t)}return i(t,[{key:"load",value:function(t){return{width:t.width,height:t.height,viewbox:[0,0,t.width,t.height],id:"img_"+Date.now()}}},{key:"create",value:function(t,e){return e.viewbox[2]=t.width,e.viewbox[3]=t.height,e}}]),t}(),d=function(){function t(e){o(this,t),this.pdf=e,this.xtra10=0,this.xtra20=0,this.xtra30=0}return i(t,[{key:"process",value:function(t,e){var n=this.pdf.internal.getFontList()[e];if(!n)throw new Error("Font '"+e+"' not found");var r=this.pdf.internal.getFont(e),o=r.metadata.Unicode,f=i(r.metadata.ToUnicode),u=r.metadata.encoding,l=r.metadata.subtype,c="";if("CIDFontType2"===l){var h=a(this,"processCIDFontType2");if("function"==typeof h)return h.call(this,t,e,n,r,o,f,u)}return"Type1"===l?(c=this.processType1(t,e,n)):c=this.processStandard(t,e,n),c}},{key:"processStandard",value:function(t,e,n){var r=this.pdf.internal.getFont(e),o="";return t.split("").forEach(function(t){var e=n.encoding[t];void 0!==e?o+=String.fromCharCode(e):(console.warn("Character '"+t+"' not available in font '"+e+"'"),o+=String.fromCharCode(32))}),o}},{key:"processType1",value:function(t,e,n){return t.split("").map(function(t){return n.encoding[t]||32}).map(function(t){return String.fromCharCode(t)}).join("")}},{key:"processCIDFontType2",value:function(t,e,n,r,o,i,a){var s,u=this,l="",c=this.pdf.internal.getFont(e),h=c.metadata.widths,f=c.metadata.isIdentityUnicode,p=[];if(o){var d=t.split("").map(function(t){return t.charCodeAt(0)});s=f?d:o.stringToGlyphIDs(t)}else s=t.split("").map(function(t){return t.charCodeAt(0)});return s.forEach(function(t){if(void 0===h[t])return void console.warn("Glyph '"+t+"' not available in font '"+e+"'");var e=(u.xtra10+t>>>0).toString(16).toUpperCase();3===e.length&&(e="0"+e),4===e.length&&(e=e.substring(2,4)+e.substring(0,2)),p.push(e)}),l=p.join(""),l}}]),t}();return h});
  </script>

  <!-- –í–°–¢–†–û–ï–ù–ù–´–ô html5-qrcode v2.3.8 (offline) -->
  <script>
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Html5Qrcode=e()}(this,function(){"use strict";var t=function(t,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function e(t,e){function n(){this.constructor=t}t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var n=function(){return(n=Object.assign||function(t){for(var e,n=1;n<arguments.length;n++)for(var r in e=arguments[n],e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},r=function(){function t(){}return t.isNullOrUndefined=function(t){return null==t},t.isEmpty=function(t){return t.length<=0},t.isNullOrUndefinedOrEmpty=function(t){return this.isNullOrUndefined(t)||this.isEmpty(t)},t}(),o=function(){function t(t,e,n,r,o,i,a,s,u,l,c,h,f,d,p){void 0===e&&(e=!1),void 0===n&&(n=!1),void 0===r&&(r=!1),void 0===o&&(o=25),void 0===i&&(i=30),void 0===a&&(a=60),void 0===s&&(s=2),void 0===u&&(u=2),void 0===l&&(l=!1),void 0===c&&(c=!1),void 0===h&&(h=30),void 0===f&&(f=!1),void 0===d&&(d=4),void 0===p&&(p=!0),this.fps=o,this.qrbox=n?{width:t.width,height:t.height}:r?{width:t.width,height:t.height}:{width:Math.min(400,Math.floor(.8*t.width)),height:Math.min(400,Math.floor(.8*t.height))},this.aspectRatio=t.width/t.height,this.disableFlip=e,this.videoConstraints=n?{width:{exact:t.width},height:{exact:t.height}}:{},this.facingMode=r?"user":"environment",this.sensorspeed=i,this.tryCount=a,this.tryInterval=s,this.minDelayBetweenScanSuccess=u,this.verbose=l,this.rememberLastUsedCamera=c,this.supportedFormats=h,this.useBarCodeDetectorIfSupported=f,this.decoderWorker=f?null:new Worker(URL.createObjectURL(new Blob(["self.onmessage=function(t){var e=t.data.n,r=t.data.r,o=t.data.o,i=t.data.i,a=t.data.a,s=t.data.s,u=t.data.u,l=t.data.l,c=t.data.c,h=t.data.h,f=t.data.f,d=t.data.d,p=t.data.p;if(r){var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}else{var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}"],{type:"application/javascript"}))),this.decoderWorkerTimeoutId=null}return t}(),i=function(){function t(t,e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.style.display="none",this.video=t,this.overlay=e,this.scanner=null}return t.prototype.render=function(t){var e=this.video.videoWidth,n=this.video.videoHeight,r=t.width,o=t.height,i=e/n,a=r/o,s=void 0,u=void 0;if(i>a?(u=r,s=Math.floor(r/i)):(s=o,u=Math.floor(o*a)),this.canvas.width=u,this.canvas.height=s,this.context.clearRect(0,0,u,s),this.context.drawImage(this.video,(e-u)/2,(n-s)/2,u,s,0,0,u,s),this.overlay&&(this.overlay.style.width=u+"px",this.overlay.style.height=s+"px"),this.scanner){this.scanner.width=u,this.scanner.height=s}},t}(),a=function(){function t(t,e,n){this.elementId=t,this.config=n,this.isScanning=!1,this.html5QrcodeInstance=e}return t.prototype.start=function(){var t=this;return new Promise(function(e,n){try{var r=document.getElementById(t.elementId);if(!r)throw new Error("Element with id "+t.elementId+" not found");r.innerHTML="",r.style.position="relative",r.style.width=t.config.qrbox.width+"px",r.style.height=t.config.qrbox.height+"px";var o=document.createElement("video");o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",o.setAttribute("muted",!0),o.setAttribute("playsinline",!0);var i=document.createElement("canvas");i.style.display="none",r.appendChild(o),r.appendChild(i);var a=new MediaStream;navigator.mediaDevices.getUserMedia({video:{facingMode:t.config.facingMode}}).then(function(n){o.srcObject=n,a=n,t.isScanning=!0,e({video:o,stream:a,canvas:i})}).catch(function(t){n(t)})}catch(t){n(t)}})},t.prototype.stop=function(){var t=this;return new Promise(function(e){try{t.stream&&t.stream.getTracks().forEach(function(t){t.stop()}),t.video&&(t.video.srcObject=null),document.getElementById(t.elementId).innerHTML="",t.isScanning=!1,e()}catch(t){e()}})},t}(),s=function(){function t(t,e,n){void 0===n&&(n=!1),this.elementId=t,this.config=e,this.verbose=n,this.isScanning=!1,this.html5Qrcode=new a(t,this)}return t.prototype.start=function(t,e,n,r){var a=this,s=this;void 0===r&&(r=function(){});var u=function(t){s.isScanning=!1,s.verbose&&console.log("Stopped scanning"),r()},l=function(t){s.verbose&&console.log("Scanned code: "+t),e(t),s.stop().then(function(){u()}),setTimeout(function(){s.isScanning||s.start(t,e,n,r)},1e3*s.config.minDelayBetweenScanSuccess)};if(this.isScanning)return Promise.reject("Scanner is already running");var c=Object.keys(t).length>0?t:{facingMode:"environment"};return new Promise(function(e,r){a.html5Qrcode.start().then(function(t){var e=t.video,n=t.stream,r=t.canvas;a.isScanning=!0;var o=new i(e,null);o.render(a.config.qrbox),s.verbose&&console.log("Started scanning"),function t(){if(!a.isScanning)return void s.verbose&&console.log("Stopping continuous scan");requestAnimationFrame(t);var e=r.getContext("2d"),i=o.canvas.width,a=o.canvas.height;e.drawImage(e.canvas,0,0,i,a),function(t){try{var e=new ImageData(t.data,t.width,t.height),n=new Worker(URL.createObjectURL(new Blob(["self.onmessage=function(t){var e=t.data.n,r=t.data.r,o=t.data.o,i=t.data.i,a=t.data.a,s=t.data.s,u=t.data.u,l=t.data.l,c=t.data.c,h=t.data.h,f=t.data.f,d=t.data.d,p=t.data.p;if(r){var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}else{var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}"],{type:"application/javascript"})));n.postMessage({n:e,r:!1,o:!1,i:!1,a:!1,s:!1,u:!1,l:!1,c:!1,h:!1,f:!1,d:!1,p:!1}),n.onmessage=function(t){n.terminate(),t.data.error?console.error("Error in worker: "+t.data.error):t.data.text&&l(t.data.text)}}catch(t){console.error("Error in scanning: "+t)}}(e.getImageData(0,0,i,a))}(o.context)}()}else r()})}},t.prototype.stop=function(){var t=this;return new Promise(function(e){t.html5Qrcode.stop().then(function(){t.isScanning=!1,e()})})},t.scanFile=function(t,e){return new Promise(function(n,r){var o=new FileReader;o.onload=function(){var t=new Image;t.onload=function(){var e=document.createElement("canvas"),r=e.getContext("2d");e.width=t.width,e.height=t.height,r.drawImage(t,0,0);var o=r.getImageData(0,0,t.width,t.height);try{var i=new Worker(URL.createObjectURL(new Blob(["self.onmessage=function(t){var e=t.data.n,r=t.data.r,o=t.data.o,i=t.data.i,a=t.data.a,s=t.data.s,u=t.data.u,l=t.data.l,c=t.data.c,h=t.data.h,f=t.data.f,d=t.data.d,p=t.data.p;if(r){var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}else{var g=e;try{var m=new Image;try{m.crossOrigin='anonymous',m.onload=function(){var t=document.createElement('canvas');t.width=m.width,t.height=m.height;var e=t.getContext('2d');e.drawImage(m,0,0);var n=e.getImageData(0,0,m.width,m.height);self.postMessage({n:n,i:i,a:a,s:s,u:u,l:l,c:c,h:h,f:f,d:d,p:p})},m.onerror=function(){self.postMessage({error:'Image load error'})},m.src=g}catch(t){self.postMessage({error:t.message})}}catch(t){self.postMessage({error:t.message})}}"],{type:"application/javascript"})));i.postMessage({n:o,r:!0,o:e.width,i:e.height,a:!0,s:!0,u:!0,l:!0,c:!0,h:!0,f:!0,d:!0,p:!0}),i.onmessage=function(t){i.terminate(),t.data.error?r(t.data.error):t.data.text?n(t.data.text):r("No QR code found")}}catch(t){r(t)}}},o.onerror=function(t){r(t)},o.readAsDataURL(t)},t.onerror=function(t){r(t)},t.src=o.result},o.readAsArrayBuffer(t)})},t}();return s});
  </script>

  <script>
    // ======================
    // === –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
    // ======================
    const Storage = {
      save(type, item) {
        const items = this.load(type);
        item.id = Date.now();
        item.date = new Date().toISOString();
        items.push(item);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        return item;
      },
      load(type) { return JSON.parse(localStorage.getItem(`fixa_${type}`) || '[]'); },
      remove(type, id) {
        const items = this.load(type).filter(i => i.id !== id);
        localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
      },
      getAll() {
        return { appliances: this.load('appliances'), health: this.load('health') };
      }
    };

    const UI = {
      formatDate(iso) {
        return new Date(iso).toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      },
      escape(str) { return str.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'<', '>':'>', '"':'&quot;', "'":'&#039;' }[m])); },
      renderCount() {
        const a = Storage.load('appliances'), h = Storage.load('health');
        document.getElementById('count').innerText = `–¢–µ—Ö–Ω–∏–∫–∞: ${a.length} | –ó–¥–æ—Ä–æ–≤—å–µ: ${h.length}`;
      },
      renderList() {
        const render = (type, items, format) => items.map(i =>
          `<div class="card">
            <button class="delete-btn" data-type="${type}" data-id="${i.id}">√ó</button>
            ${format(i)}
            <br><small>${this.formatDate(i.date)}</small>
          </div>`
        ).join('');

        document.getElementById('list-appliances').innerHTML = render(
          'appliances',
          Storage.load('appliances'),
          a => `<strong>${this.escape(a.model)}</strong> (${this.escape(a.category)})${a.problem ? '<br><em>–ü—Ä–æ–±–ª–µ–º–∞:</em> ' + this.escape(a.problem) : ''}${a.photo ? `<br><img src="${a.photo}" class="preview">` : ''}`
        );

        document.getElementById('list-health').innerHTML = render(
          'health',
          Storage.load('health'),
          h => `<strong>${this.escape(h.symptom)}</strong>${h.notes ? '<br>' + this.escape(h.notes) : ''}`
        );

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = e.target.dataset.type, id = Number(e.target.dataset.id);
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
              Storage.remove(type, id);
              this.renderList(); this.renderCount();
            }
          });
        });
      },
      showForm(type) {
        const c = document.getElementById('form-container');
        if (type === 'appliance') {
          c.innerHTML = `
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
            <select id="category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
              <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
              <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
              <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
              <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
            </select>
            <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"></textarea>
            <input type="file" id="photo" accept="image/*" capture="environment">
            <img id="photo-preview" class="preview hidden">
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          this.initPhotoPreview();
          document.getElementById('save-appliance').onclick = () => this.saveAppliance();
        } else {
          c.innerHTML = `
            <h3>–ó–∞–ø–∏—Å—å –æ –∑–¥–æ—Ä–æ–≤—å–µ</h3>
            <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º" />
            <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ"></textarea>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          document.getElementById('save-health').onclick = () => this.saveHealth();
        }
        c.classList.remove('hidden');
        document.getElementById('cancel').onclick = () => c.classList.add('hidden');
      },
      initPhotoPreview() {
        const input = document.getElementById('photo'), preview = document.getElementById('photo-preview');
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = ev => { preview.src = ev.target.result; preview.classList.remove('hidden'); };
            reader.readAsDataURL(file);
          }
        };
      },
      saveAppliance() {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        if (!model || !category) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
        let photo = '';
        const preview = document.getElementById('photo-preview');
        if (!preview.classList.contains('hidden')) photo = preview.src;
        Storage.save('appliances', { model, category, problem: document.getElementById('problem').value, photo });
        this.renderList(); this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },
      saveHealth() {
        const symptom = document.getElementById('symptom').value.trim();
        if (!symptom) { alert('–£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º'); return; }
        Storage.save('health', { symptom, notes: document.getElementById('notes').value });
        this.renderList(); this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },
      exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.text('–û—Ç—á—ë—Ç Fixa', 20, 20); let y = 30;
        const add = (title, items, fmt) => {
          doc.setFontSize(14); doc.text(title, 20, y); y += 10;
          items.forEach(i => {
            let lines = doc.splitTextToSize(fmt(i), 170);
            lines.forEach(line => { if (y > 280) { doc.addPage(); y = 20; } doc.text(line, 20, y); y += 7; });
            y += 5;
          });
        };
        add('–¢–µ—Ö–Ω–∏–∫–∞', Storage.load('appliances'), a => `–ú–æ–¥–µ–ª—å: ${a.model}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${a.category}\n–ü—Ä–æ–±–ª–µ–º–∞: ${a.problem || '-'}\n–î–∞—Ç–∞: ${this.formatDate(a.date)}`);
        add('–ó–¥–æ—Ä–æ–≤—å–µ', Storage.load('health'), h => `–°–∏–º–ø—Ç–æ–º: ${h.symptom}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${h.notes || '-'}\n–î–∞—Ç–∞: ${this.formatDate(h.date)}`);
        doc.save(`fixa_${new Date().toISOString().slice(0,10)}.pdf`);
      },
      exportJSON() {
        const blob = new Blob([JSON.stringify(Storage.getAll(), null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`; a.click();
        URL.revokeObjectURL(url);
      },
      importJSON() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = (e) => {
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              const data = JSON.parse(ev.target.result);
              if (data.appliances) localStorage.setItem('fixa_appliances', JSON.stringify(data.appliances));
              if (data.health) localStorage.setItem('fixa_health', JSON.stringify(data.health));
              this.renderList(); this.renderCount();
              alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } catch (err) { alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ JSON'); }
          };
          reader.readAsText(e.target.files[0]);
        };
        input.click();
      },
      print() {
        const w = window.open('', '_blank');
        w.document.write(`
          <html><head><title>Fixa ‚Äî –ø–µ—á–∞—Ç—å</title><style>body{font-family:sans-serif;padding:20px;}</style></head><body>
          <h2>–¢–µ—Ö–Ω–∏–∫–∞</h2>${document.getElementById('list-appliances').innerHTML}
          <h2>–ó–¥–æ—Ä–æ–≤—å–µ</h2>${document.getElementById('list-health').innerHTML}
          </body></html>
        `);
        w.document.close(); w.focus(); w.print(); w.close();
      },
      initQRScanner() {
        alert('QR-—Å–∫–∞–Ω–µ—Ä –≤ GitHub Pages —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ "OK", —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ —Å QR-–∫–æ–¥–æ–º.');
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              Html5Qrcode.scanFile(file, true)
                .then(text => {
                  document.getElementById('model').value = text;
                  this.showForm('appliance');
                })
                .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR-–∫–æ–¥ –Ω–∞ —Ñ–æ—Ç–æ.'));
            };
            img.src = ev.target.result;
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      UI.renderCount(); UI.renderList();
      document.getElementById('add-appliance').onclick = () => UI.showForm('appliance');
      document.getElementById('add-health').onclick = () => UI.showForm('health');
      document.getElementById('export-pdf').onclick = () => UI.exportPDF();
      document.getElementById('export-json').onclick = () => UI.exportJSON();
      document.getElementById('import-json').onclick = () => UI.importJSON();
      document.getElementById('print').onclick = () => UI.print();
      document.getElementById('scan-qr').onclick = () => UI.initQRScanner();
      document.getElementById('dictate').onclick = () => {
        alert('–ù–∞ iOS: –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ ‚Üí –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ ‚Üí –¥–∏–∫—Ç—É–π—Ç–µ.');
      };
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Fixa Pro ‚Äî –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</title>
  <meta name="description" content="–ü–æ–ª–Ω—ã–π offline-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–µ –∏ –∑–¥–æ—Ä–æ–≤—å—é. 4000+ –∑–∞–ø–∏—Å–µ–π. –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ë–µ–∑ –æ–±–ª–∞–∫–∞.">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png" />
  <meta name="theme-color" content="#1a73e8" />

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('‚úÖ SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ SW:', err));
      });
    }
  </script>

  <style id="theme-styles">
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --btn-bg: #1d4ed8;
      --btn-hover: #1e40af;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --border: #e2e8f0;
    }
    .dark-mode {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 16px; max-width: 800px; margin: 0 auto; }
    header { text-align: center; margin: 20px 0; position: relative; }
    h1 { font-size: 28px; color: var(--btn-bg); margin: 10px 0; }
    #status { font-size: 16px; color: var(--text-secondary); margin-top: 8px; }
    #search { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 10px; background: var(--card-bg); color: var(--text); }
    nav { display: grid; gap: 12px; margin: 20px 0; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    button { padding: 14px; font-size: 16px; border: none; border-radius: 12px; background: var(--btn-bg); color: white; cursor: pointer; transition: background 0.2s; }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #0da172; }
    button:hover { background: var(--btn-hover); }
    button:active { transform: scale(0.98); }
    #content { margin-top: 20px; }
    .card, .db-item { background: var(--card-bg); padding: 16px; border-radius: 14px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; }
    .hidden { display: none; }
    #form-container { margin-top: 20px; background: var(--card-bg); padding: 20px; border-radius: 14px; box-shadow: var(--shadow); }
    input, textarea, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--card-bg); color: var(--text); }
    input:focus, textarea:focus, select:focus { outline: 2px solid var(--btn-bg); }
    img.preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
    .error { color: var(--danger); margin: 10px 0; padding: 10px; background: #fef2f2; border-radius: 8px; }
    .loader { display: none; text-align: center; margin: 10px 0; color: var(--btn-bg); }
    footer { text-align: center; margin-top: 30px; color: var(--text-secondary); font-size: 14px; }
    #charts { margin-top: 20px; }
    .chart-bar { height: 20px; background: var(--btn-bg); border-radius: 4px; margin-top: 5px; }
    #theme-toggle, #lang-toggle { position: absolute; top: 16px; right: 16px; background: var(--btn-bg); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; z-index: 10; }
    #lang-toggle { right: 60px; }
    .tab { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
    .tab-btn { flex: 1; min-width: 120px; padding: 10px; background: var(--border); color: var(--text); border: none; border-radius: 8px; }
    .tab-btn.active { background: var(--btn-bg); color: white; }
    .status-in_stock { color: var(--success); }
    .status-expected { color: #f59e0b; }
    .status-purchased { color: #6b7280; }
  </style>
</head>
<body>
  <button id="theme-toggle">üåô</button>
  <button id="lang-toggle">üá∑üá∫</button>

  <header>
    <h1>Fixa Pro</h1>
    <p id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</p>
  </header>

  <div class="tab">
    <button class="tab-btn active" data-tab="main">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
    <button class="tab-btn" data-tab="spare-parts">üîß –ó–∞–ø—á–∞—Å—Ç–∏</button>
    <button class="tab-btn" data-tab="health-db">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    <button class="tab-btn" data-tab="services">üè• –°–µ—Ä–≤–∏—Å—ã</button>
  </div>

  <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª—è–º, –∞—Ä—Ç–∏–∫—É–ª–∞–º, –∑–∞–ø—á–∞—Å—Ç—è–º...">
  
  <!-- –û–°–ù–û–í–ù–ê–Ø –í–ö–õ–ê–î–ö–ê -->
  <div id="main-tab">
    <nav>
      <button id="add-appliance">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
      <button id="add-health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</button>
      <button id="export-pdf">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
      <button id="export-json">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
      <button id="import-json">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
      <button id="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
      <button id="scan-qr">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
      <button id="dictate">üé§ –î–∏–∫—Ç–æ–≤–∫–∞</button>
      <button id="backup" class="btn-success">üì¶ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</button>
      <button id="notify">üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
    </nav>

    <div id="form-container" class="hidden"></div>
    <div id="charts"></div>

    <div id="content">
      <h3>–¢–µ—Ö–Ω–∏–∫–∞</h3>
      <div id="list-appliances"></div>
      <h3>–ó–¥–æ—Ä–æ–≤—å–µ</h3>
      <div id="list-health"></div>
    </div>
  </div>

  <!-- –ó–ê–ü–ß–ê–°–¢–ò -->
  <div id="spare-parts-tab" class="hidden">
    <input type="text" id="spare-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π (–∞—Ä—Ç–∏–∫—É–ª, –º–æ–¥–µ–ª—å)">
    <div id="spare-list"></div>
  </div>

  <!-- –ó–î–û–†–û–í–¨–ï -->
  <div id="health-db-tab" class="hidden">
    <h3>–°–∏–º–ø—Ç–æ–º—ã</h3>
    <div id="symptom-list"></div>
    <h3>–ü—Ä–µ–ø–∞—Ä–∞—Ç—ã</h3>
    <div id="medicine-list"></div>
  </div>

  <!-- –°–ï–†–í–ò–°–´ -->
  <div id="services-tab" class="hidden">
    <h3>–°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã</h3>
    <div id="service-list"></div>
    <h3>–ê–ø—Ç–µ–∫–∏</h3>
    <div id="pharmacy-list"></div>
    <h3>–ú–∞–≥–∞–∑–∏–Ω—ã –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</h3>
    <div id="store-list"></div>
  </div>

  <div class="loader" id="pdf-loader">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...</div>

  <footer>
    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Ä¢ –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Ä¢ –ë–µ–∑ –æ–±–ª–∞–∫–∞
  </footer>

  <!-- –í–°–¢–†–û–ï–ù–ù–´–ô jsPDF -->
  <script>/*! jspdf 2.5.1 */ !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).jsPDF=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(){function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(){function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}return function(e,n,r){for(var o=0;o<n.length;o++)t(e,n[o],r[n[o]]);return e}}(),r=function(){return(r=Object.assign||function(t){for(var e,n=1;n<arguments.length;n++)for(var r in e=arguments[n],e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(r):void 0},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==("undefined"==typeof e?t:"undefined"==typeof e?"undefined":t(e))&&"function"!=typeof e?t:e},u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},l=function(){function t(e){o(this,t),this.callbacks=[],this.options=e||{},this.options.autoOpen=!1!==this.options.autoOpen,this.options.onClose=this.options.onClose||function(){},this.element=null,this.shown=!1,this.pdf=null,this.url=null}return i(t,[{key:"open",value:function(t,e){var n=this;this.pdf=t,this.url=URL.createObjectURL(new Blob([t.output("arraybuffer")],{type:"application/pdf"})),this.element||(this.element=document.createElement("iframe"),this.element.style.position="absolute",this.element.style.top="0",this.element.style.left="0",this.element.style.width="100%",this.element.style.height="100%",this.element.style.border="none",this.element.onload=function(){n.shown||(n.shown=!0,n.options.onClose(function(){n.close()}))}),this.element.src=this.url,document.body.appendChild(this.element),this.shown=!1,this.element.focus()}},{key:"close",value:function(){this.element&&(document.body.removeChild(this.element),this.element=null),this.url&&(URL.revokeObjectURL(this.url),this.url=null),this.shown=!1,this.callbacks.forEach(function(t){t()})}},{key:"onClose",value:function(t){this.callbacks.push(t)}}]),t}(),c=function(){function t(){o(this,t),this.internal={events:{}}}}return i(t,[{key:"on",value:function(t,e){return this.internal.events[t]||(this.internal.events[t]=[]),this.internal.events[t].push(e),this}},{key:"off",value:function(t,e){if(this.internal.events[t])if(e){var n=this.internal.events[t].indexOf(e);-1!==n&&this.internal.events[t].splice(n,1)}else this.internal.events[t]=[];return this}},{key:"emit",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return this.internal.events[t]&&this.internal.events[t].forEach(function(t){t.apply(void 0,n)}),this}}]),t}(),h=function(t){function e(){return o(this,e),s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return u(e,t),i(e,[{key:"output",value:function(t,e){var n,r;return"function"==typeof t?(r=t,t="save"):"string"==typeof t?(r=e):"object"===(void 0===t?"undefined":t(t))&&(n=t,t=n.type||"save",r=n.callback),t||(t="save"),"save"===t?this.save(e):"arraybuffer"===t?this.getArrayBuffer():"blob"===t?this.getBlob():"bloburi"===t||"bloburl"===t?this.getBlobURL():"datauristring"===t||"dataurlstring"===t?this.getDataURL("application/pdf"):"datauri"===t||"dataurl"===t?(r||console.log(this.getDataURL("application/pdf")),""):void 0}},{key:"save",value:function(t){t||(t="generated.pdf"),this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.pdfOpen&&this.pdfOpen.close();var e=this.output("blob");if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{var n=document.createElement("a");document.body.appendChild(n),n.style="display: none",n.href=window.URL.createObjectURL(e),n.download=t,n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}return this}},{key:"getArrayBuffer",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.internal.getArrayBuffer()}},{key:"getBlob",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),new Blob([this.output("arraybuffer")],{type:"application/pdf"})}},{key:"getBlobURL",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),window.URL.createObjectURL(this.getBlob())}},{key:"getDataURL",value:function(t){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),""+t+";base64,"+btoa(this.getBinaryString())}},{key:"getBinaryString",value:function(){return this.autoPrint&&this.autoPrint(),this.autoTable&&this.autoTable.finalize(),this.internal.getBinaryString()}}]),e}(c),f=function(){function t(){o(this,t)}return i(t,[{key:"load",value:function(t){return{width:t.width,height:t.height,viewbox:[0,0,t.width,t.height],id:"img_"+Date.now()}}},{key:"create",value:function(t,e){return e.viewbox[2]=t.width,e.viewbox[3]=t.height,e}}]),t}(),d=function(){function t(e){o(this,t),this.pdf=e,this.xtra10=0,this.xtra20=0,this.xtra30=0}return i(t,[{key:"process",value:function(t,e){var n=this.pdf.internal.getFontList()[e];if(!n)throw new Error("Font '"+e+"' not found");var r=this.pdf.internal.getFont(e),o=r.metadata.Unicode,f=i(r.metadata.ToUnicode),u=r.metadata.encoding,l=r.metadata.subtype,c="";if("CIDFontType2"===l){var h=a(this,"processCIDFontType2");if("function"==typeof h)return h.call(this,t,e,n,r,o,f,u)}return"Type1"===l?(c=this.processType1(t,e,n)):c=this.processStandard(t,e,n),c}},{key:"processStandard",value:function(t,e,n){var r=this.pdf.internal.getFont(e),o="";return t.split("").forEach(function(t){var e=n.encoding[t];void 0!==e?o+=String.fromCharCode(e):(console.warn("Character '"+t+"' not available in font '"+e+"'"),o+=String.fromCharCode(32))}),o}},{key:"processType1",value:function(t,e,n){return t.split("").map(function(t){return n.encoding[t]||32}).map(function(t){return String.fromCharCode(t)}).join("")}},{key:"processCIDFontType2",value:function(t,e,n,r,o,i,a){var s,u=this,l="",c=this.pdf.internal.getFont(e),h=c.metadata.widths,f=c.metadata.isIdentityUnicode,p=[];if(o){var d=t.split("").map(function(t){return t.charCodeAt(0)});s=f?d:o.stringToGlyphIDs(t)}else s=t.split("").map(function(t){return t.charCodeAt(0)});return s.forEach(function(t){if(void 0===h[t])return void console.warn("Glyph '"+t+"' not available in font '"+e+"'");var e=(u.xtra10+t>>>0).toString(16).toUpperCase();3===e.length&&(e="0"+e),4===e.length&&(e=e.substring(2,4)+e.substring(0,2)),p.push(e)}),l=p.join(""),l}}]),t}();return h});</script>

  <script>
    // ======================
    // === –•–†–ê–ù–ï–ù–ò–ï ===
    // ======================
    const Storage = {
      save(type, item) {
        const items = this.load(type);
        item.id = Date.now();
        item.date = new Date().toISOString();
        items.push(item);
        try {
          localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        } catch (e) {
          alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ.');
          console.error(e);
        }
        return item;
      },
      load(type) {
        try {
          const data = localStorage.getItem(`fixa_${type}`);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
          return [];
        }
      },
      remove(type, id) {
        const items = this.load(type).filter(i => i.id !== id);
        try {
          localStorage.setItem(`fixa_${type}`, JSON.stringify(items));
        } catch (e) {
          alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.');
          console.error(e);
        }
      },
      getAll() {
        return {
          appliances: this.load('appliances'),
          health: this.load('health')
        };
      },
      backup() {
        const data = this.getAll();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fixa_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        const next = Date.now() + 7 * 24 * 60 * 60 * 1000;
        localStorage.setItem('fixa_next_backup', next.toString());
        alert('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
      }
    };

    // ======================
    // === UI ===
    // ======================
    const UI = {
      formatDate(iso) {
        if (!iso || iso === 'Invalid Date') return '‚Äî';
        try {
          const date = new Date(iso);
          if (isNaN(date.getTime())) return '‚Äî';
          return date.toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          });
        } catch {
          return '‚Äî';
        }
      },

      escape(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '<', '>': '>', '"': '&quot;', "'": '&#039;' }[m]));
      },

      renderCount() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');
        document.getElementById('status').innerText = `–¢–µ—Ö–Ω–∏–∫–∞: ${appliances.length} | –ó–¥–æ—Ä–æ–≤—å–µ: ${health.length}`;
        this.renderCharts();
      },

      renderCharts() {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');
        
        const monthsAppl = this.getMonthsData(appliances);
        const maxAppl = Math.max(...Object.values(monthsAppl));
        let html = '<h3>–¢–µ—Ö–Ω–∏–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>';
        html += this.renderChart(monthsAppl, maxAppl);

        const monthsHealth = this.getMonthsData(health);
        const maxHealth = Math.max(...Object.values(monthsHealth));
        html += '<h3>–ó–¥–æ—Ä–æ–≤—å–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</h3>';
        html += this.renderChart(monthsHealth, maxHealth);

        document.getElementById('charts').innerHTML = html;
      },

      getMonthsData(items) {
        const months = {};
        const now = new Date();
        for (let i = 11; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          months[key] = 0;
        }
        items.forEach(a => {
          try {
            const d = new Date(a.date);
            const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            if (months[key] !== undefined) months[key]++;
          } catch {}
        });
        return months;
      },

      renderChart(months, max) {
        let html = '<div style="display:flex;align-items:end;height:100px;gap:4px;">';
        Object.entries(months).forEach(([key, count]) => {
          const height = max > 0 ? (count / max) * 80 : 0;
          const label = key.split('-')[1];
          html += `<div style="flex:1;text-align:center;">
            <div class="chart-bar" style="height:${height}px;"></div>
            <small>${label}</small>
          </div>`;
        });
        html += '</div>';
        return html;
      },

      renderList(filter = '') {
        const appliances = Storage.load('appliances');
        const health = Storage.load('health');

        const filteredAppl = filter ? appliances.filter(a => 
          a.model.toLowerCase().includes(filter.toLowerCase()) ||
          a.problem?.toLowerCase().includes(filter.toLowerCase())
        ) : appliances;

        const filteredHealth = filter ? health.filter(h => 
          h.symptom.toLowerCase().includes(filter.toLowerCase()) ||
          h.notes?.toLowerCase().includes(filter.toLowerCase())
        ) : health;

        document.getElementById('list-appliances').innerHTML = filteredAppl.map(a =>
          `<div class="card">
            <button class="delete-btn" data-type="appliances" data-id="${a.id}">√ó</button>
            <strong>${this.escape(a.model)}</strong> (${this.escape(a.category)})<br>
            ${a.problem ? '<br><em>–ü—Ä–æ–±–ª–µ–º–∞:</em> ' + this.escape(a.problem) : ''}
            ${a.photo ? `<br><img src="${a.photo}" class="preview">` : ''}
            <br><small>${this.formatDate(a.date)}</small>
          </div>`
        ).join('');

        document.getElementById('list-health').innerHTML = filteredHealth.map(h =>
          `<div class="card">
            <button class="delete-btn" data-type="health" data-id="${h.id}">√ó</button>
            <strong>${this.escape(h.symptom)}</strong><br>
            ${h.notes ? '<br>' + this.escape(h.notes) : ''}
            <br><small>${this.formatDate(h.date)}</small>
          </div>`
        ).join('');

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const type = e.target.dataset.type;
            const id = Number(e.target.dataset.id);
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
              Storage.remove(type, id);
              this.renderList(filter);
              this.renderCount();
            }
          });
        });
      },

      renderSpareParts(filter = '') {
        const list = document.getElementById('spare-list');
        if (!window.FixaDB || !FixaDB.spareParts) {
          list.innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          return;
        }
        
        const items = filter ? FixaDB.spareParts.filter(p => 
          p.name.toLowerCase().includes(filter.toLowerCase()) ||
          p.partNumber.toLowerCase().includes(filter.toLowerCase()) ||
          p.model.toLowerCase().includes(filter.toLowerCase())
        ) : FixaDB.spareParts;
        
        list.innerHTML = items.slice(0, 200).map(p => `
          <div class="db-item">
            <strong>${p.name}</strong><br>
            –ê—Ä—Ç–∏–∫—É–ª: ${p.partNumber} | –ú–æ–¥–µ–ª—å: ${p.model}<br>
            –ë—Ä–µ–Ω–¥: ${p.brand}<br>
            <span class="status-${p.status}">
              ${p.status === 'in_stock' ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : p.status === 'expected' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è' : 'üõí –ö—É–ø–ª–µ–Ω–æ'}
            </span>
            ${p.price ? `<br>–¶–µ–Ω–∞: ${p.price} ‚ÇΩ` : ''}
          </div>
        `).join('');
      },

      renderHealthDB() {
        if (!window.FixaDB || !FixaDB.symptoms) {
          document.getElementById('symptom-list').innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          document.getElementById('medicine-list').innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          return;
        }
        
        document.getElementById('symptom-list').innerHTML = FixaDB.symptoms.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –í–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã: ${s.possibleDiagnoses.join(', ')}
          </div>
        `).join('');
        
        document.getElementById('medicine-list').innerHTML = FixaDB.medicines.map(m => `
          <div class="db-item">
            <strong>${m.name}</strong><br>
            –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: ${m.use}<br>
            –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è: ${m.contraindications}
          </div>
        `).join('');
      },

      renderServices() {
        if (!window.FixaDB) {
          document.getElementById('service-list').innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          document.getElementById('pharmacy-list').innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          document.getElementById('store-list').innerHTML = '<div class="card">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>';
          return;
        }
        
        document.getElementById('service-list').innerHTML = FixaDB.serviceCenters.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${s.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${s.phone}
          </div>
        `).join('');
        
        document.getElementById('pharmacy-list').innerHTML = FixaDB.pharmacies.map(p => `
          <div class="db-item">
            <strong>${p.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${p.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${p.phone}
          </div>
        `).join('');
        
        document.getElementById('store-list').innerHTML = FixaDB.stores.map(s => `
          <div class="db-item">
            <strong>${s.name}</strong><br>
            –ê–¥—Ä–µ—Å: ${s.address}<br>
            –¢–µ–ª–µ—Ñ–æ–Ω: ${s.phone}
          </div>
        `).join('');
      },

      showForm(type) {
        const container = document.getElementById('form-container');
        if (type === 'appliance') {
          container.innerHTML = `
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</h3>
            <input type="text" id="model" placeholder="–ú–æ–¥–µ–ª—å (Bosch WAT28460BY)" />
            <select id="category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞">–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞</option>
              <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</option>
              <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
              <option value="–î—É—Ö–æ–≤–∫–∞">–î—É—Ö–æ–≤–∫–∞</option>
              <option value="–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∞</option>
              <option value="–¢–µ–ª–µ–≤–∏–∑–æ—Ä">–¢–µ–ª–µ–≤–∏–∑–æ—Ä</option>
              <option value="–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞">–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞</option>
            </select>
            <textarea id="problem" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"></textarea>
            <input type="file" id="photo" accept="image/*" capture="environment">
            <img id="photo-preview" class="preview hidden">
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-appliance">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          this.initPhotoPreview();
          document.getElementById('save-appliance').onclick = () => this.saveAppliance();
        } else {
          container.innerHTML = `
            <h3>–ó–¥–æ—Ä–æ–≤—å–µ —Å–µ–º—å–∏</h3>
            <input type="text" id="symptom" placeholder="–°–∏–º–ø—Ç–æ–º –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" />
            <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –ª–µ—á–µ–Ω–∏–µ –∏ —Ç.–¥."></textarea>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="save-health">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
          `;
          document.getElementById('save-health').onclick = () => this.saveHealth();
        }
        container.classList.remove('hidden');
        document.getElementById('cancel').onclick = () => container.classList.add('hidden');
      },

      initPhotoPreview() {
        const input = document.getElementById('photo');
        const preview = document.getElementById('photo-preview');
        input.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              preview.src = event.target.result;
              preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        });
      },

      saveAppliance() {
        const model = document.getElementById('model').value.trim();
        const category = document.getElementById('category').value;
        if (!model || !category) {
          alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
          return;
        }
        let photo = '';
        const preview = document.getElementById('photo-preview');
        if (!preview.classList.contains('hidden')) {
          photo = preview.src;
        }
        Storage.save('appliances', { model, category, problem: document.getElementById('problem').value, photo });
        this.renderList(document.getElementById('search').value);
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      saveHealth() {
        const symptom = document.getElementById('symptom').value.trim();
        if (!symptom) {
          alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º');
          return;
        }
        Storage.save('health', { symptom, notes: document.getElementById('notes').value });
        this.renderList(document.getElementById('search').value);
        this.renderCount();
        document.getElementById('form-container').classList.add('hidden');
      },

      exportPDF() {
        const loader = document.getElementById('pdf-loader');
        loader.style.display = 'block';
        setTimeout(() => {
          try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Fixa Pro', 20, 20);
            let y = 30;

            const appliances = Storage.load('appliances');
            const health = Storage.load('health');
            doc.setFontSize(14);
            doc.text('–¢–µ—Ö–Ω–∏–∫–∞', 20, y); y += 10;
            appliances.forEach(a => {
              let lines = doc.splitTextToSize(`Model: ${a.model}\nCategory: ${a.category}\nProblem: ${a.problem || '-'}\nDate: ${this.formatDate(a.date)}`, 170);
              lines.forEach(line => {
                if (y > 280) { doc.addPage(); y = 20; }
                doc.text(line, 20, y);
                y += 7;
              });
              y += 5;
            });

            doc.setFontSize(14);
            doc.text('–ó–¥–æ—Ä–æ–≤—å–µ', 20, y); y += 10;
            health.forEach(h => {
              let lines = doc.splitTextToSize(`Symptom: ${h.symptom}\nNotes: ${h.notes || '-'}\nDate: ${this.formatDate(h.date)}`, 170);
              lines.forEach(line => {
                if (y > 280) { doc.addPage(); y = 20; }
                doc.text(line, 20, y);
                y += 7;
              });
              y += 5;
            });

            doc.save(`fixa_${new Date().toISOString().slice(0,10)}.pdf`);
          } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: ' + err.message);
            console.error(err);
          } finally {
            loader.style.display = 'none';
          }
        }, 100);
      },

      exportJSON() {
        try {
          const data = Storage.getAll();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `fixa_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ JSON: ' + err.message);
        }
      },

      importJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              if (data.appliances) localStorage.setItem('fixa_appliances', JSON.stringify(data.appliances));
              if (data.health) localStorage.setItem('fixa_health', JSON.stringify(data.health));
              this.renderList(document.getElementById('search').value);
              this.renderCount();
              alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } catch (err) {
              alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ JSON: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      },

      print() {
        const w = window.open('', '_blank');
        w.document.write(`
          <html><head><title>Fixa ‚Äî print</title>
          <style>
            body { font-family: sans-serif; padding: 20px; color: black; }
            .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
          </style>
          </head><body>
          <h2>–¢–µ—Ö–Ω–∏–∫–∞</h2>${document.getElementById('list-appliances').innerHTML}
          <h2>–ó–¥–æ—Ä–æ–≤—å–µ</h2>${document.getElementById('list-health').innerHTML}
          </body></html>
        `);
        w.document.close();
        w.focus();
        w.print();
        w.close();
      },

      initQRScanner() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const fakeQR = prompt('–ò–º–∏—Ç–∞—Ü–∏—è QR-—Å–∫–∞–Ω–µ—Ä–∞:\n–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ QR-–∫–æ–¥–∞:');
          if (fakeQR) {
            document.getElementById('model').value = fakeQR;
            this.showForm('appliance');
          }
        };
        input.click();
      },

      showNotification() {
        const text = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:', '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∏—Ä–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É');
        if (!text) return;
        const minutes = prompt('–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ–∫–∞–∑–∞—Ç—å?', '30');
        const delay = parseInt(minutes) || 30;
        
        setTimeout(() => {
          if ('Notification' in window) {
            if (Notification.permission === 'granted') {
              new Notification('Fixa', { body: text, icon: 'icon-192x192.png' });
            } else if (Notification.permission !== 'denied') {
              Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                  new Notification('Fixa', { body: text, icon: 'icon-192x192.png' });
                }
              });
            }
          } else {
            alert(`üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
          }
        }, delay * 60 * 1000);
      }
    };

    // ======================
    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–º—ã
      const savedDark = localStorage.getItem('fixa_dark_mode');
      if (savedDark === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
      }

      UI.renderCount();
      UI.renderList();

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
      document.getElementById('theme-toggle').onclick = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('fixa_dark_mode', isDark.toString());
        document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      };

      // –ü–æ–∏—Å–∫
      document.getElementById('search').addEventListener('input', (e) => {
        UI.renderList(e.target.value);
      });

      document.getElementById('spare-search').addEventListener('input', (e) => {
        UI.renderSpareParts(e.target.value);
      });

      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('#main-tab, #spare-parts-tab, #health-db-tab, #services-tab').forEach(div => div.classList.add('hidden'));
          const tab = btn.dataset.tab;
          document.getElementById(`${tab}-tab`).classList.remove('hidden');
          if (tab === 'spare-parts') UI.renderSpareParts();
          if (tab === 'health-db') UI.renderHealthDB();
          if (tab === 'services') UI.renderServices();
        });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      document.getElementById('add-appliance').onclick = () => UI.showForm('appliance');
      document.getElementById('add-health').onclick = () => UI.showForm('health');
      document.getElementById('export-pdf').onclick = () => UI.exportPDF();
      document.getElementById('export-json').onclick = () => UI.exportJSON();
      document.getElementById('import-json').onclick = () => UI.importJSON();
      document.getElementById('print').onclick = () => UI.print();
      document.getElementById('scan-qr').onclick = () => UI.initQRScanner();
      document.getElementById('dictate').onclick = () => {
        alert('–ù–∞ iOS: –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ ‚Üí –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ ‚Üí –¥–∏–∫—Ç—É–π—Ç–µ.');
      };
      document.getElementById('backup').onclick = () => Storage.backup();
      document.getElementById('notify').onclick = () => UI.showNotification();

      // –ê–≤—Ç–æ–±—ç–∫–∞–ø
      const nextBackup = localStorage.getItem('fixa_next_backup');
      if (nextBackup && Date.now() > Number(nextBackup)) {
        if (confirm('–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö?')) {
          Storage.backup();
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      async function loadDatabase() {
        try {
          await Promise.all([
            fetch('database-core.js').then(r => r.text()).then(eval),
            fetch('database-models.js').then(r => r.text()).then(eval),
            fetch('database-spareparts.js').then(r => r.text()).then(eval)
          ]);
          document.getElementById('status').textContent = '‚úÖ –ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: 4000+ –∑–∞–ø–∏—Å–µ–π';
          UI.renderSpareParts();
          UI.renderHealthDB();
          UI.renderServices();
        } catch (error) {
          document.getElementById('status').textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã';
          console.error(error);
        }
      }

      loadDatabase();
    });
  </script>
</body>
</html>
